<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>jQuery + OData + Netflix Catalog API</title>
	<link href="movies.css" rel="stylesheet" type="text/css" />
	<link type="text/css" href="../jquery-ui-1.8.1.custom.css" rel="stylesheet" />	
	<link href="../jquery-ui-1.8.1.custom.css" rel="stylesheet" type="text/css" /></head>
<body>
<div id="pageBody">

	<h1>Netflix: Book a Movie...</h1>
	
	<ul id="genres">
		<li class="selected">Cartoons</li>
		<li>Drama</li>
		<li>Foreign</li>
		<li>Action Classics</li>
		<li>Horror</li>
		<li>Sci-Fi Cult Classics</li>
	</ul>
	
	<div id="pager"><ul class="pages"><li class="pgEmpty">first</li><li class="pgEmpty">prev</li></ul></div>
	
	<div id="movieList"></div>
	
	<table id="bookingsList">
		<tbody><tr class="bookingsHeader"><td class="cart-false" colspan="4">
			0 bookings in Cart... 
		</td></tr></tbody>
	</table>
	<br/>
</div>

<script src="http://code.jquery.com/jquery.js"></script>
<script src="../jquery.tmpl.js" type="text/javascript"></script>
<script src="jquery.pager.js" type="text/javascript"></script>
<script src="../jquery-ui-1.8.1.custom.js" type="text/javascript"></script>

<script id="movieTmpl" type="text/html">
	<div>
		<div><img src="${BoxArt.LargeUrl}" /> </div>
		<strong>${Name}</strong>
		<p>${Synopsis}</p>
		<input type="button" title="Buy tickets for '${Name}'" value="Buy tickets..." class="buyButton"/>
		<br/>
	</div>
</script>

<script id="bookingHeaderTmpl" type="text/html">
	<td class="cart-${!!count}" colspan="4">
		${count} bookings in Cart... 
		{{if count}} 
			<input id="submit" type="button" value="Submit Bookings" /> 
			<input id="cancel" type="button" value="Cancel" />
		{{/if}}
	</td>	   
</script>

<script id="bookingTitleTmpl" type="text/html">
	<tr class="bookingTitle${$context.mode}" >
		<td>${movie.Name}</td><td>${movieTheater}</td>
		<td>${formatDate(date)}</td>
		<td>
			${quantity}
			<span class="ui-icon close"></span>
		</td>
	</tr>
</script>

<script id="bookingEditTmpl" type="text/html">
	{{render(this, {mode: "Edit"}) "#bookingTitleTmpl"}}
	<tr class="bookingEdit" >
		<td colspan="4">
			<div class="fields">
				<span>Movie Theater: </span><input class="theater" type="text" value="${movieTheater}" /><br/>
				<span>Date: </span><input class="date" type="text" value="${formatDate(date)}" /><br/>
				<span>Quantity: </span><input class="quantity" type="text" value="${quantity}" />
			</div>
			<div><img src="${movie.BoxArt.LargeUrl}" /></div>
		</td>
	</tr>
</script>

<script type="text/javascript">
	var genre="Cartoons", pageIndex=1, pageSize=3, pageCount=0,
		bookings = { selected: null, movies: {}, count: 0 };

	getMovies( pageIndex );

	$( "#genres li" ).click( selectGenre );

	$( ".bookingsHeader" ).empty().append( "#bookingHeaderTmpl", bookings );
	
	var bookingsHeaderContext = $.templateContexts[1];
	
	$( "#submit" ).live( "click", function() {
		alert( bookings.count + " bookings submitted...");
		removeBookings.apply( this ); 
	});

	$( "#cancel" ).live( "click", function() {
		removeBookings.apply( this ); 
	});

	function selectGenre() {
		$( "#genres li" ).removeClass( "selected" );
		$( this ).addClass( "selected" );

		pageIndex = 1;
		genre = encodeURI( $(this).text() ); 
		getMovies( pageIndex );
	}

	function getMovies( index ) {
		var query = "http://odata.netflix.com/Catalog/Genres('" + genre + "')/Titles" +
			"?$format=json" +
			"&$inlinecount=allpages" +				// get total number of records
			"&$skip=" + (index-1) * pageSize +		// skip to first record of page
			"&$top=" + pageSize;					// page size

		pageIndex = index;

		$( "#movieList" )
			.fadeOut( "medium", function () {
				$.ajax({
					dataType: "jsonp",
					url: query,
					jsonp: "$callback",
					success: showMovies
				});
			});
	}
	
	function showMovies( data ) {
		pageCount = Math.ceil( data.d.__count/pageSize ),
			movies = data.d.results;
		
		$( "#pager" ).pager({ pagenumber: pageIndex, pagecount: pageCount, buttonClickCallback: getMovies });
		
		// show movies in template
		$( "#movieList" )
			.empty()
			.append( "#movieTmpl", movies, { rendered: onMovieRendered } )
			.fadeIn( "fast" );
	}

	function buyTickets( movie ) {
		// Add item to bookings list
		if ( bookings.movies[movie.Id] ) {
			bookings.movies[movie.Id].quantity++;
		} else {
			bookings.count++;
			bookingsHeaderContext.update();
			bookings.movies[movie.Id] = { movie: movie, date: new Date(), quantity: 1, movieTheater: "" };
		}
		selectBooking( bookings.movies[movie.Id] );
	}

	function selectBooking( booking ) {
		var selected = bookings.selected;
		if ( selected === booking ) {
			refreshBooking( booking.context );
			return;
		}
		// Make new booking selected, and render in edit view
		bookings.selected = booking;
		renderEditView( booking );
		
		if ( selected ) {
			// Collapse previously selected booking, and switch to non-edit view
			$( "div", selected.context.nodes ).animate( { height: 0 }, 500, function() { 
				switchView( selected.context );
			});
		}
	}

	function switchView( ctx, edit ) {
		if ( edit ) {  
			ctx.update({ 
				tmpl: "#bookingEditTmpl", 
				rendered: onBookingEditRendered 
			}); 
		} else {
			ctx.update({ 
				tmpl: "#bookingTitleTmpl", 
				rendered: onBookingRendered 
			}); 
		}
	}
	function renderEditView( booking ) {
		if ( !booking ) {
			return;
		}
		if ( booking.context ) {
			switchView( booking.context, true );
		} else {
			$( "#bookingsList" ).append( "#bookingEditTmpl", booking, { animate: true, rendered: onBookingEditRendered } );
		}
	}

	function onMovieRendered( context ) { 
      	$( "div", context.nodes ).fadeIn( 4000 );
		$( ".buyButton", context.nodes ).click( function() { 
			buyTickets( context.data ); 
		});
	}

	function onBookingRendered( context ) {
		this.data.context = context;
		$( context.nodes ).click( function() { 
			selectBooking( context.data );
		});
		$( ".close", context.nodes ).click( removeBooking );
	}

	function onBookingEditRendered( context ) {
		var data = context.data, nodes = context.nodes;
		data.context = context;

		$( nodes[0] ).click( function() { 
			selectBooking();
		});

		$( ".close", nodes ).click( removeBooking );
		
		$( ".date", nodes ).change( function() {
			data.date = $(this).datepicker( "getDate" );
			refreshBooking( context );
		})
		.datepicker({ dateFormat: "DD, d MM, yy" });

		$( ".quantity", nodes ).change( function() {
			data.quantity = $(this).val();
			refreshBooking( context );
		});

		$( ".theater", nodes ).change( function() {
			data.movieTheater = $(this).val();
			refreshBooking( context );
		});

		if ( context.animate ) {
			$( "div", nodes ).css( "height", 0 ).animate( { height: 116 }, 500 );
		}
	}

	function refreshBooking( context ) {
		context.animate = false;
		context.update();
		context.animate = true;
	}	
	
	function removeBooking() {
		var context = $(this).templateContext();
		if ( context.data === bookings.selected ) {
			context = context.parent;
			bookings.selected = null;
		}
		delete bookings.movies[context.data.movie.Id];
		bookings.count--;
		bookingsHeaderContext.update();
		context.remove();
		return false; 
	}			
	
	function removeBookings() {
		for (var movie in bookings.movies) {
			bookings.movies[movie].context.remove();
		}
		bookings.selected = null;
		bookings.count = 0;
		bookings.movies = {};
		bookingsHeaderContext.update();
	}			
	
	function formatDate( context, date ) {
		return date.toLocaleDateString();
	}
</script>

</body>
</html>

