<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>jQuery + OData + Netflix Catalog API</title>
	<link href="movies.css" rel="stylesheet" type="text/css" />
</head>
<body>

<div id="pageBody">

	<h1>Netflix: Book a Movie...</h1>
	
	<ul id="genres">
		<li class="selected">Cartoons</li>
		<li>Drama</li>
		<li>Foreign</li>
		<li>Action Classics</li>
		<li>Horror</li>
		<li>Sci-Fi Cult Classics</li>
	</ul>
	
	<div id="pager"><ul class="pages"><li class="pgEmpty">first</li><li class="pgEmpty">prev</li></ul></div>
	
	<div id="movieList"></div>

	<table id="bookingsList"></table>
	<br/>
</div>
<script src="http://code.jquery.com/jquery.js" type="text/javascript"></script>
<script src="../jquery.tmpl.js" type="text/javascript"></script>
<script src="jquery.pager.js" type="text/javascript"></script>

<script id="movieTemplate" type="text/html">
	<div>
		<div><img src="${BoxArt.LargeUrl}" /> </div>
		<strong>${Name}</strong>
		<p>${Synopsis}</p>
		<input type="button" title="Buy tickets for '${Name}'" value="Buy tickets..." class="buyButton"/>
		<br/>
	</div>
</script>

<script id="bookingsListTemplate" type="text/html">
	{{each movies}}
		<tr>
			{{if selected === movie.Id}}
				{{render(this, { rendered: onBookingEditRendered }) "#bookingEditTemplate"}}
			{{else}}
				{{render(this, { rendered: onBookingRendered }) "#bookingTemplate"}}
			{{/if}}
		</tr>
	{{/each}}
</script>

<script id="bookingEditTemplate" type="text/html">
	<td class="editBooking" colspan="4">
		<div class="fields">
			<strong>${movie.Name}</strong><br/>
			<div>
				<span>Movie Theater: </span><input type="text" value="${movieTheatre}" /><br/>
				<span>Date: </span><input type="text" value="${formatDate(date)}" /><br/>
				<span>Quantity: </span><input type="text" value="${quantity}" />
			</div>
		</div>
		<div><img src="${movie.BoxArt.LargeUrl}" /></div>
	</td>
</script>

<script id="bookingTemplate" type="text/html">
	<td>${movie.Name}</td>
	<td>${movieTheatre}</td>
	<td>${formatDate(date)}</td>
	<td>${quantity}</td>
</script>

<script type="text/javascript">
	var genre="Cartoons", pageIndex=1, pageSize=3, pageCount=0,
		bookings = { selected: 0, movies: {} };

	getMovies(pageIndex);

	$( "#genres li" ).click( selectGenre );

	function selectGenre() {
		$( "#genres li" ).removeClass( "selected" );
		$( this ).addClass( "selected" );

		pageIndex = 1;
		genre = encodeURI( $(this).text() ); 
		getMovies(pageIndex);
	}

	function getMovies( index ) {
		var query = "http://odata.netflix.com/Catalog/Genres('" + genre + "')/Titles" +
			"?$format=json" +
			"&$inlinecount=allpages" +				// get total number of records
			"&$skip=" + (index-1) * pageSize +		// skip to first record of page
			"&$top=" + pageSize;					// page size

		pageIndex = index;

		$( "#movieList" )
			.fadeOut( "medium", function () {
				$.ajax({
					dataType: "jsonp",
					url: query,
					jsonp: "$callback",
					success: showMovies
				});
			});
	}
	
	function showMovies( data ) {
		pageCount = Math.ceil( data.d.__count/pageSize ),
			movies = data.d.results;
		
		$( "#pager" ).pager({ pagenumber: pageIndex, pagecount: pageCount, buttonClickCallback: getMovies });
		
		// show movies in template
		$( "#movieList" )
			.empty()
			.append( "#movieTemplate", movies, { rendered: onMovieRendered } )
			.fadeIn( "fast" );
	}

	function buyTickets(data) {
		// Add item to bookings list
		bookings.movies[data.Id] = { movie: data, date: new Date(), quantity: 1, movieTheatre: "" };
		selectBooking(data.Id);
	}

	function selectBooking(id) {
		if (bookings.selected) {
			$("div", bookings.selectedElem).animate( {height:"-=100"}, 650, function() { book(id); } );
		}
		else {
			book(id);
		}
	}

	function book(id) {
		bookings.selected = id;
		$("#bookingsList").empty().append("#bookingsListTemplate", bookings);
	}

	function onMovieRendered( nodes, context ) { 
      	$( "div", nodes ).fadeIn( 4000 );
		$( ".buyButton", nodes ).click( function() { 
			buyTickets(context.data); 
		});
	}

	function onBookingRendered( nodes, context ) {
		$(nodes).click(function(){ 
			selectBooking(context.data.movie.Id); 
		});
	}

	function onBookingEditRendered( nodes, context ) {
		bookings.selectedElem = nodes[0];
      	$( "div", nodes ).animate( {height:"+=100"}, 500 );
	}

	function formatDate(context, date) {
		return date.toLocaleDateString();
	}
</script>

</body>
</html>

