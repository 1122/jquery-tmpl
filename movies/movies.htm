<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>jQuery + OData + Netflix Catalog API</title>
	<link href="movies.css" rel="stylesheet" type="text/css" />
	<style type="text/css">
	  	div.test { margin: 0px; width: 100px; height: 80px; background: green; border: 1px solid black; position: relative; }
	</style>
</head>
<body>

<div id="pageBody">

	<h1>Netflix: Book a Movie...</h1>
	
	<ul id="genres">
		<li class="selected">Cartoons</li>
		<li>Drama</li>
		<li>Foreign</li>
		<li>Action Classics</li>
		<li>Horror</li>
		<li>Sci-Fi Cult Classics</li>
	</ul>
	
	<div id="pager"></div>
	
	<div id="movieContainer"></div>
	
</div>

<script src="http://code.jquery.com/jquery.js" type="text/javascript"></script>
<script src="../jquery.tmpl.js" type="text/javascript"></script>
<script src="jquery.pager.js" type="text/javascript"></script>

<script id="movieTemplate" type="text/html">
	<div>
		<div><img src="${BoxArt.LargeUrl}" /> </div>
		<strong>${Name}</strong>
		<p>${Synopsis}</p>
		<input type="button" title="Buy tickets for '${Name}'" value="Buy tickets..." class="buyButton"/>
		<br/>
	</div>
</script>

<script type="text/javascript">

	var genre="Cartoons", pageIndex=1, pageSize=3;

	getMovies(pageIndex);

	$( "#genres li" ).click( selectGenre );

	function buyTickets(data) {
		alert(data.Name);
	}

	function selectGenre() {
		$( "#genres li" ).removeClass( "selected" );
		$( this ).addClass( "selected" );

		pageIndex = 1;
		genre = encodeURI( $(this).text() ); 
		getMovies(pageIndex);
	}

	function getMovies( index ) {
		var query = "http://odata.netflix.com/Catalog/Genres('" + genre + "')/Titles" +
			"?$format=json" +
			"&$inlinecount=allpages" +				// get total number of records
			"&$skip=" + (index-1) * pageSize +		// skip to first record of page
			"&$top=" + pageSize;					// page size

		pageIndex = index;

		$( "#movieContainer" )
			.fadeOut( "medium", function () {
				$.ajax({
					dataType: "jsonp",
					url: query,
					jsonp: "$callback",
					success: showMovies
				});
			});
	}
	
	function showMovies( data ) {
		var pageCount = Math.ceil( data.d.__count/pageSize ),
			movies = data.d.results;
		
		$( "#pager" ).pager({ pagenumber: pageIndex, pagecount: pageCount, buttonClickCallback: getMovies });
		
		// show movies in template
		$( "#movieContainer" )
			.empty()
			.append( "#movieTemplate", movies, { rendered: onMovieRendered } )
			.fadeIn( "fast" );
	}

	function onMovieRendered( nodes, context ) { 
      	$( "div", nodes ).fadeIn( 4000 );
		$( ".buyButton", nodes ).click( function() { 
			buyTickets(context.data); 
		});
	}
</script>

</body>
</html>

